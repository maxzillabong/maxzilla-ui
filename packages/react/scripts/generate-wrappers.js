#!/usr/bin/env node

import fs from 'fs/promises'
import path from 'path'

// Component definitions with their props and events
const componentDefinitions = {
  'mz-button': {
    props: {
      variant: "'primary' | 'secondary' | 'outline' | 'ghost' | 'danger'",
      size: "'sm' | 'md' | 'lg'",
      loading: 'boolean',
      disabled: 'boolean',
      href: 'string',
      target: 'string',
      rel: 'string',
      type: "'button' | 'submit' | 'reset'"
    },
    events: {
      onClick: 'click'
    }
  },
  'mz-card': {
    props: {
      elevation: "'none' | 'sm' | 'md' | 'lg' | 'xl'",
      clickable: 'boolean',
      href: 'string',
      target: 'string',
      rel: 'string'
    },
    events: {
      onClick: 'click'
    }
  },
  'mz-input': {
    props: {
      type: "'text' | 'email' | 'password' | 'number' | 'tel' | 'url' | 'search'",
      label: 'string',
      placeholder: 'string',
      value: 'string | number',
      disabled: 'boolean',
      required: 'boolean',
      readonly: 'boolean',
      error: 'boolean',
      helperText: 'string',
      size: "'sm' | 'md' | 'lg'"
    },
    events: {
      onChange: 'change',
      onInput: 'input',
      onFocus: 'focus',
      onBlur: 'blur'
    }
  },
  'mz-badge': {
    props: {
      variant: "'default' | 'primary' | 'secondary' | 'success' | 'warning' | 'error'",
      size: "'sm' | 'md' | 'lg'",
      dot: 'boolean'
    },
    events: {}
  },
  'mz-avatar': {
    props: {
      src: 'string',
      alt: 'string',
      size: "'sm' | 'md' | 'lg' | 'xl'",
      shape: "'circle' | 'square'",
      online: 'boolean',
      initials: 'string'
    },
    events: {}
  },
  'mz-modal': {
    props: {
      open: 'boolean',
      size: "'sm' | 'md' | 'lg' | 'xl' | 'full'",
      closable: 'boolean',
      backdrop: 'boolean'
    },
    events: {
      onClose: 'close',
      onOpen: 'open'
    }
  }
}

function toPascalCase(str) {
  return str.replace(/mz-/, '').replace(/-([a-z])/g, (_, letter) => letter.toUpperCase())
    .replace(/^[a-z]/, letter => letter.toUpperCase())
}

function generateWrapper(tagName, definition) {
  const componentName = toPascalCase(tagName)
  const { props, events } = definition
  
  const propsInterface = Object.entries(props)
    .map(([key, type]) => `  ${key}?: ${type}`)
    .join('\n')
  
  const eventProps = Object.keys(events)
    .map(key => `  ${key}?: (event: Event) => void`)
    .join('\n')
  
  const eventMap = Object.keys(events).length > 0 
    ? `const eventMap = {
  ${Object.entries(events).map(([react, web]) => `${react}: '${web}'`).join(',\n  ')}
}`
    : 'const eventMap = {}'

  return `import React from 'react'
import { createReactWrapper, type WebComponentProps } from '../utils/createReactWrapper.js'

export interface ${componentName}Props extends WebComponentProps {
${propsInterface}${eventProps ? '\n' + eventProps : ''}
}

${eventMap}

const Mz${componentName} = createReactWrapper<HTMLElement>('${tagName}'${Object.keys(events).length > 0 ? ', eventMap' : ''})

export const ${componentName} = Mz${componentName} as React.ForwardRefExoticComponent<${componentName}Props>

${componentName}.displayName = '${componentName}'`
}

function generateIndex(componentNames) {
  const exports = componentNames.map(name => {
    const componentName = toPascalCase(name)
    return `export { ${componentName}, type ${componentName}Props } from './components/${componentName}.js'`
  }).join('\n')
  
  return `// Auto-generated React wrapper components for Maxzilla UI
// Do not edit this file directly - use npm run generate to regenerate

export { useWebComponents } from './utils/createReactWrapper.js'

${exports}`
}

async function generateWrappers() {
  const srcDir = new URL('../src', import.meta.url).pathname
  const componentsDir = path.join(srcDir, 'components')
  
  // Ensure directories exist
  await fs.mkdir(componentsDir, { recursive: true })
  
  // Generate individual component files
  for (const [tagName, definition] of Object.entries(componentDefinitions)) {
    const componentName = toPascalCase(tagName)
    const content = generateWrapper(tagName, definition)
    const filePath = path.join(componentsDir, `${componentName}.tsx`)
    
    await fs.writeFile(filePath, content)
    console.log(`Generated ${componentName}.tsx`)
  }
  
  // Generate index file
  const indexContent = generateIndex(Object.keys(componentDefinitions))
  const indexPath = path.join(srcDir, 'index.ts')
  await fs.writeFile(indexPath, indexContent)
  console.log('Generated index.ts')
  
  console.log(`âœ… Generated ${Object.keys(componentDefinitions).length} React wrapper components`)
}

generateWrappers().catch(console.error)